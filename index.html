<!doctype html>

<script>
  const CONFIG = {

    // the category, name, key, url, search path and color for your commands
    // if none of the specified keys are matched, the '*' key is used
    // ['type', 'name', 'shortcut', 'url', 'searchURL', 'color', 'image', 'icon'],  
    commands: [
    ['News', 'Ars Technica', 'ars', 'http://arstechnica.com/', '/search/?ie=UTF-8&q={}', '#FCE9DA', 'images/arstechnica.svg', 'computer'],
    ['News', 'The Register', 'reg', 'https://www.theregister.co.uk/', null, '#FF0000', null,'computer'],
    ['News', 'Overclockers AU', 'ocau', 'http://overclockers.com.au/', null, '#0C1347', null,'memory'],
    ['News', 'Reddit', 'r', 'https://www.reddit.com', '/search?q={}', '#5f99cf', 'images/reddit.svg', 'line_style'],
    ['News', 'The Age', 'age', 'http://theage.com.au/', null, '#333', null,'reorder'],
    ['News', 'BBC News', 'bbc', 'http://www.bbc.com/news', '/search?q={}', '#BB1919', 'images/bbc.svg','reorder'],
    ['News', 'The Guardian', 'gd', 'https://www.theguardian.com/international', null, '#C2E9FF', 'images/guardian.svg','reorder'],
    ['Watch', 'BBC iplayer', 'ip', 'http://bbc.co.uk/iplayer/', '/iplayer/search?q={}', '#FCC5DE', 'images/iplayer.SVG', 'tv'],
    ['Watch', 'YouTube', 'y', 'https://youtube.com/feed/subscriptions', '/results?search_query={}', '#FCE9DA', 'images/youtube.svg', 'live_tv'],
    ['Watch', 'ITV Player', 'itv', 'https://www.itv.com/itvplayer/', '/hub/{}', '#19BEC8', null,'tv'],
    ['Watch', 'My5', 'my5', 'https://www.my5.tv/', null, '#333', null,'tv'],
    ['Watch', 'Daily Motion', 'dm', 'http://www.dailymotion.com/gb', '/relevance/universal/search/{}', '#0066DC', 'images/dailymotion.svg','tv'],
    ['Watch', 'Netflix', 'nf', 'https://www.netflix.com/browse', 'https://www.netflix.com/search?q={}', '#333', 'images/netflix.svg','tv'],    
    ['Watch', 'FreeSAT Guide', 'freesat', 'http://www.freesat.co.uk/tvguide', null, '#006F39', null,'satellite'],
    ['Watch', 'IMDB', 'imdb', 'http://imdb.com', '/find?ref_=nv_sr_fn&q={}', '#E6B91E', 'images/imdb.svg','movie'],
    ['Shop', 'Amazon', 'a', 'https://www.amazon.co.uk/', '/s/ref=nb_sb_noss_2?url=search-alias%3Daps&field-keywords={}', '#FCE7C5', 'images/amazon.svg', 'shopping_cart'],
    ['Shop', 'eBay', 'e', 'https://www.ebay.co.uk/', '/sch/i.html?_from=R40&_trksid=p2380057.m570.l1313.TR12.TRC2.A0.H0.Xtest.TRS0&_nkw={}', '#3392FF', 'images/ebay.svg','shopping_cart'],
    ['Shop', 'Aliexpress', 'ali', 'https://www.aliexpress.com', '/wholesale?catId=0&SearchText={}', '#FCE9DA', 'images/aliexpress.svg','shopping_cart'],
    ['Shop', 'HotUKDeals', 'hduk', 'https://hotukdeals.com', '/search?q={}', '#a3be8c', null,'attach_money'],
    ['Shop', 'Quidco', 'quid', 'http://quidco.com/', '/search?q={}', '#3d70b7', 'images/quidco.png','attach_money'],
    ['Shop', 'After Ship', 'as', 'http://www.aftership.com/', '/search?q={}', '#FCE7C5', 'images/aftership.svg', 'local_shipping'],
    ['Travel', 'Google Maps', 'map', 'https://maps.google.com/', null, '#333', null,'place'],
    ['Travel', 'City Mapper', 'cm', 'https://citymapper.com/london?set_region=uk-london', null, '#E1F6DF', 'images/citymapper.png','place'],
    ['Travel', 'Opodo', 'opodo', 'https://opodo.com/', null, '#FF6600', null,'flight_takeoff'],
    ['Travel', 'SkyScanner', 'skyscanner', 'https://skyscanner.net/', null, '#00B2D6', null,'flight'],
    ['Travel', 'Wotif', 'wi', 'http://wotif.com/', null, '#EBF7DE', 'images/wotif.gif','hotel'],            
    ['Travel', 'Last Minute', 'lm', 'https://lastminute.com/', null, '#FCE9DA', 'images/lastminute.png','hotel'], 
    ['Social', 'Facebook', 'f', 'https://www.facebook.com', '/search/top/?q={}', '#3b5998', 'images/facebook.svg','face'],
    ['Social', 'Gmail', 'g', 'https://mail.google.com', null, '#d14836', 'images/gmail.svg','email'],
    ['Social', 'Outlook', 'o', 'https://outlook.com', 'null', '#FCE9DA', 'images/outlook.svg','mail_outline'],
    ['Social', 'Whatsapp', 'wa', 'https://web.whatsapp.com', '/search/{}', '#FCE9DA', 'images/whatsapp.png','speaker_notes'],
    ['Computer', 'GitHub', 'gh', 'https://github.com', '/search?q={}', '#333333', 'images/github.svg', 'memory'],
    ['Computer', 'Arch Linux', 'arch', 'https://archlinux.org', null, '#333333', 'images/archlinux.svg','laptop_chromebook'],
    ['Computer', 'AUR', 'aur', 'https://aur.archlinux.org', '/packages/?O=0&K={}', '#333333', 'images/archlinux.svg','laptop_chromebook'],
    ['Computer', 'XDA Forums', 'xda', 'https://forum.xda-developers.com/', '/sitesearch.php?q={}', '#4c566a', 'images/xda.svg','android'],
    ['Computer', 'Home Assistant', 'homeassistant', 'https://home-assistant.io/', 'null', '#eceff4', 'images/homeassistant.png','home'],
    ['Games', 'Steam', 'st', 'https://store.steampowered.com/', '/search/?term={}', '#171a21', 'images/steam.svg','games'],
    ['Games', 'Humble Bundle', 'hb', 'https://humblebundle.com/', '/store/search?sort=bestselling&search={}', '#CD2D32', 'images/humblebundle.svg','games'],
    ['Games', 'Indie Gala', 'ig', 'https://www.indiegala.com/', '/store/search?type=games&key={}}&page=1', '#E0E0E0', null,'games'],
    ['Comics', 'Comicvine', 'cv', 'https://comicvine.gamespot.com/', '/search/?indices[0]=issue&indices[1]=series&indices[2]=volume&page=1&q={}', '#198F19', 'images/comicvine.png','chat_bubble'],
    ['Comics', 'Newsarama', 'nr', 'http://newsarama.com/', null, '#333', null,'chat_bubble_outline'],
    ['Comics', 'Valient Universe', 'vu', 'http://valiantuniverse.com/news/', null, '#333', null,'chat_bubble_outline'],
    ['Comics', 'GetComics', 'gc', 'https://getcomics.info', null, '#333', null,'chat_bubble_outline'],
    ['Comics', 'GetComics', 'gc', 'https://getcomics.info', null, '#333', null,'chat_bubble_outline'],     
    ['Stuff', 'SCIFi Bulletin', 'sfb', 'https://scifibulletin.com/', '/?s={}', '#9CB2BF', null,'wb_sunny'],
    ['Stuff', 'Big Finish', 'bf', 'https://scifibulletin.com/', null, '#3F4450', null,'music_note'],
    ['Stuff', 'Instructables', 'instructables', 'https://www.instructables.com/', null, '#FBC116', null,'build'],
    ['Kids', 'ClassDojo', 'dojo', 'http://classdojo.com/', null, '#96C748', null, 'school'],
  ],

  // give suggestions as you type
  suggestions: true,

  // max amount of suggestions that will ever be displayed
  suggestionsLimit: 9,

  // the order and limit for each suggestion influencer
  // "Default" suggestions come from CONFIG.defaultSuggestions
  // "DuckDuckGo" suggestions come from the duck duck go search api
  // "History" suggestions come from your previously entered queries
  influencers: [
    { name: 'Default', limit: 7 },
    { name: 'History', limit: 2 },
    { name: 'DuckDuckGo', limit: 6 },
  ],

  // default search suggestions for the specified queries
  defaultSuggestions: {
    'gh': ['gh/crass00', 'gh/issues', 'gh/pulls', 'gist.github.com'],
    'r': ['r/r/startpages', 'r/r/technology', 'r/r/europe', 'r/r/funny'],
    'xda': ['xda/mi-pad', 'xda/oneplus-x'],
    'hduk': ['hduk/new', 'hduk/hot'], 
    'cv': ['cv/new-comics', 'cv/previews', 'cv/news'],
    'phone': ['vodafone.co.uk', 'talkmobile.co.uk', 'bt.com', 'ee.co.uk'], 
    'energy': ['britishgas.co.uk', 'edfenergy.co.uk'],  
    'shop': ['ebuyer.co.uk', 'scan.co.uk'], 
    'webtools': ['colllor.com', 'materialicons.com'],
  },

    // instantly redirect when a key is matched
    // put a space before any other queries to prevent unwanted redirects
    instantRedirect: false,

    // open queries in a new tab
    newTab: true,

    // dynamic background colors when command domains are matched
    colors: true,

    // the delimiter between the key and your search query
    // e.g. to search GitHub for potatoes you'd type "g:potatoes"
    searchDelimiter: ':',

    // the delimiter between the key and a path
    // e.g. type "r/r/unixporn" to go to "reddit.com/r/unixporn"
    pathDelimiter: '/',

    // the delimiter between the hours and minutes in the clock
    clockDelimiter: ':',

    // note: you can pass in your search query via the q query param
    // e.g. going to file:///path/to/tilde/index.html?q=hamsters is equivalent
    // to typing "hamsters" and pressing enter
  };
</script>

<meta charset="utf-8">
<meta http-equiv="x-dns-prefetch-control" content="on">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="noindex">
<link rel="icon" type="image/png" href="icon.png" />

<title>~</title>

<style type="text/css">
  @import url('https://fonts.googleapis.com/css?family=Lato:400,900');
  @import url('http://fonts.googleapis.com/icon?family=Material+Icons');

  body {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    transition: background .2s;
    font-family: Lato, sans-serif;
    color: #222;
    background: url('sw-v.jpg') no-repeat center center fixed; 
    -webkit-background-size: cover;
    -moz-background-size: cover;
    -o-background-size: cover;
    background-size: cover; 
  }

  input,
  button,
  input:focus,
  button:focus {
    display: block;
    box-sizing: border-box;
    width: 100%;
    margin: 0;
    border: 0;
    outline: 0;
    background: transparent;
    color: #fff;
    font-family: Lato, sans-serif;
    text-align: center;
    -webkit-appearance: none;
    -moz-appearance: none;
  }

  ul,
  li {
    margin: 0;
    padding: 0;
    list-style: none;
  }

  a,
  a:focus {
    color: inherit;
    outline: 0;
  }

  #clock {
    display: block;
    margin-top: -.06em;
    font-size: 6rem;
    letter-spacing: .05em;
    text-align: center;
    cursor: pointer;
  }

  #search-form {
    padding: 1em;
    background: #111;
    transition: background-color .5s;
    box-sizing: border-box;
    z-index: 2;
  }

  #search-form>div {
    width: 100%;
  }

  #search-input,
  #search-input:focus {
    width: 100%;
    margin-bottom: 20px;
    font-size: 1.5em;
    font-weight: 900;
    letter-spacing: .05em;
    text-transform: uppercase;
  }

  #search-suggestions {
    display: none;
    flex-wrap: wrap;
    justify-content: center;
  }

  body.suggestions #search-suggestions {
    display: flex;
  }

  .search-suggestion {
    padding: .7em 1em;
    white-space: nowrap;
    font-size: 1.1em;
    cursor: pointer;
  }

  .search-suggestion.highlight {
    background-color: #fff;
    color: #222;
  }

  .search-suggestion b {
    position: relative;
    font-weight: 400;
  }

  .search-suggestion b::after {
    content: ' ';
    position: absolute;
    top: 51%;
    right: 0;
    left: 0;
    height: 3px;
    background-color: #fff;
    opacity: .8;
  }

  .search-suggestion.highlight b::after {
    opacity: 0;
  }

  #help {
    display: block;
    padding: 8vw;
    background: transparent;
    font-size: 1.3rem;
    z-index: 1;
  }

  .category {
    margin-bottom: 2rem;
  }

  .category:last-of-type {
    margin-bottom: 0;
  }

  .category-name {
    margin: 0 0 2rem;
    font-size: .7em;
    letter-spacing: .2em;
    text-transform: uppercase;
  }

  .command a {
    display: block;
    position: relative;
    margin: 1em 0;
    font-size: .9em;
    line-height: 2em;
    text-decoration: none;
  }

  .command:last-of-type a {
    margin-bottom: 0;
  }

  .command-material-icons {
    display:inline-block;
    vertical-align:middle
  }

  .command-key {
    display: block;
    float: left;
    width: 2.5em;
    margin-right: 1em;
    border-radius: 50%;
    background-color: #222;
    color: #fff;
    font-size: .8em;
    text-align: center;
  }

  .command-name {
    position: relative;
    overflow: hidden;
  }

  .command-name::after {
    content: ' ';
    position: absolute;
    right: 0;
    bottom: -.35em;
    left: 0;
    height: 2px;
    transition: .2s;
    transform: translateX(-2em);
    background-color: #222;
    opacity: 0;
  }

  .command a:hover .command-name::after,
  .command a:focus .command-name::after {
    transform: translateX(0);
    opacity: 1;
  }

  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    overflow: auto;
    box-sizing: border-box;
    width: 100%;
    height: 100%;
    visibility: hidden;
  }

  body.help #help.overlay,
  body.form #search-form.overlay {
    visibility: visible;
  }

  .center {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
  }

  @media (min-width: 500px) {
    .categories {
      display: grid;
      grid-template-columns: 250px 185px;
      justify-content: space-around;
    }

    .category:nth-last-child(2) {
      margin-bottom: 0;
    }

    #search-input,
    #search-input:focus {
      font-size: 3em;
    }
  }

  @media (min-width: 1000px) {
    #help {
      display: flex;
      padding: 0;
    }

    .category {
      margin: 2rem 0;
    }

    .categories {
      grid-template-columns: repeat(2, 300px) 185px;
    }
  }

  @media (min-width: 1700px) {
    .categories {
      grid-template-columns: repeat(5, 250px) 185px;
    }
  }
</style>

<div class="center">
    <div>
        <time id="clock"></time>
        <aside id="help"></aside>
      </div>
</div>

<form class="overlay center" id="search-form" autocomplete="off" spellcheck="false">
    <img id="search-logo" src="http://evolveddigital.co.uk/wp-content/uploads/2017/02/DuckDuckGo-Logo.png" style="position: fixed;padding-bottom: 400px;" height="188">
  <div>
    <input id="search-input" type="text">
    <ul id="search-suggestions"></ul>
  </div>

</form>

<script>
  const $ = {
    bodyClassAdd: c => $.el('body').classList.add(c),
    bodyClassHas: c => $.el('body').classList.contains(c),
    bodyClassRemove: c => $.el('body').classList.remove(c),
    el: s => document.querySelector(s),
    els: s => [].slice.call(document.querySelectorAll(s) || []),
    escapeRegex: s => s.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'),
    ieq: (a, b) => a.toLowerCase() === b.toLowerCase(),
    iin: (a, b) => a.toLowerCase().indexOf(b.toLowerCase()) !== -1,
    isDown: e => ['c-n', 'down', 'tab'].includes($.key(e)),
    isRemove: e => ['backspace', 'delete'].includes($.key(e)),
    isUp: e => ['c-p', 'up', 's-tab'].includes($.key(e)),

    jsonp: url => {
      let script = document.createElement('script');
      script.src = url;
      $.el('head').appendChild(script);
    },

    key: e => {
      const ctrl = e.ctrlKey;
      const shift = e.shiftKey;

      switch (e.which) {
        case 8: return 'backspace';
        case 9: return shift ? 's-tab' : 'tab';
        case 13: return 'enter';
        case 16: return 'shift';
        case 17: return 'ctrl';
        case 18: return 'alt';
        case 27: return 'escape';
        case 38: return 'up';
        case 40: return 'down';
        case 46: return 'delete';
        case 78: return ctrl ? 'c-n' : 'n';
        case 80: return ctrl ? 'c-p' : 'n';
        case 91: return 'super';
      }
    },
  };

  class Clock {
    constructor(options) {
      this._el = $.el('#clock');
      this._delimiter = options.delimiter;
      this._form = options.form;
      this._setTime = this._setTime.bind(this);
      this._registerEvents();
      this._start();
    }

    _pad(num) {
      return ('0' + num.toString()).slice(-2);
    }

    _registerEvents() {
      this._el.addEventListener('click', this._form.show);
    }

    _setTime() {
      const date = new Date();
      const hours = this._pad(date.getHours());
      const minutes = this._pad(date.getMinutes());
      this._el.innerHTML = hours + this._delimiter + minutes;
    }

    _start() {
      this._setTime();
      setInterval(this._setTime, 1000);
    }
  }

  class Help {
    constructor(options) {
      this._el = $.el('#help');
      this._commands = options.commands;
      this._newTab = options.newTab;
      this._toggled = false;
      this._buildAndAppendLists();
      this._bindMethods();
      this._registerEvents();
    }

    toggle(show) {
      this._toggled = (typeof show !== 'undefined') ? show : !this._toggled;
      this._toggled ? $.bodyClassAdd('help') : $.bodyClassRemove('help');
    }

    _bindMethods() {
      this._handleKeydown = this._handleKeydown.bind(this);
    }

    _buildAndAppendLists() {
      const lists = document.createElement('ul');
      lists.classList.add('categories');

      this._getCategories().forEach(category => {
        lists.insertAdjacentHTML(
          'beforeend',
          `<li class="category">
            <h2 class="category-name">${category}</h2>
            <ul>${this._buildListCommands(category)}</ul>
          </li>`
        );
      });

      this._el.appendChild(lists);
    }

    _buildListCommands(category) {
      return this._commands.map(([cmdCategory, name, key, url, , search,  ,materialicon]) => {
        if (cmdCategory === category) {
          return (
            `<li class="command">
              <a href="${url}" target="${this._newTab ? '_blank' : '_self'}">
                <span class="material-icons">${materialicon}</span>
                <span class="command-name">${name}</span>
              </a>
            </li>`
          );
        }
      }).join('');
    }

    _getCategories() {
      const categories = this._commands
        .map(([category]) => category)
        .filter(category => category);

      return [...new Set(categories)];
    }

    _handleKeydown(e) {
      if ($.key(e) === 'escape') this.toggle(false);
    }

    _registerEvents() {
      document.addEventListener('keydown', this._handleKeydown);
    }
  }

  class Influencer {
    constructor(options) {
      this._limit = options.limit;
      this._queryParser = options.queryParser;
    }

    addItem() {}
    getSuggestions() {}

    _addSearchPrefix(items, query) {
      const searchPrefix = this._getSearchPrefix(query)
      return items.map(s => searchPrefix ? searchPrefix + s : s);
    }

    _getSearchPrefix(query) {
      const { isSearch, key, split } = this._parseQuery(query);
      return isSearch ? `${key}${split} ` : false;
    }

    _parseQuery(query) {
      return this._queryParser.parse(query);
    }
  }

  class DefaultInfluencer extends Influencer {
    constructor({ defaultSuggestions }) {
      super(...arguments);
      this._defaultSuggestions = defaultSuggestions;
    }

    getSuggestions(query) {
      return new Promise(resolve => {
        const suggestions = this._defaultSuggestions[query];
        resolve(suggestions ? suggestions.slice(0, this._limit) : []);
      });
    }
  }

  class DuckDuckGoInfluencer extends Influencer {
    constructor({ queryParser }) {
      super(...arguments);
    }

    getSuggestions(rawQuery) {
      const { query } = this._parseQuery(rawQuery);
      if (!query) return Promise.resolve([]);

      return new Promise(resolve => {
        const endpoint = 'https://duckduckgo.com/ac/';
        const callback = 'autocompleteCallback';

        window[callback] = res => {
          const suggestions = res.map(i => i.phrase)
            .filter(s => !$.ieq(s, query))
            .slice(0, this._limit)

          resolve(this._addSearchPrefix(suggestions, rawQuery));
        };

        $.jsonp(`${endpoint}?callback=${callback}&q=${query}`);
      });
    }
  }

  class HistoryInfluencer extends Influencer {
    constructor() {
      super(...arguments);
      this._storeName = 'history';
    }

    addItem(query) {
      if (query.length < 2) return;
      let exists;

      const history = this._getHistory().map(([item, count]) => {
        const match = $.ieq(item, query);
        if (match) exists = true;
        return [item, match ? count + 1 : count];
      });

      if (!exists) history.push([query, 1]);
      this._setHistory(this._sort(history));
    }

    getSuggestions(query) {
      return new Promise(resolve => {
        const suggestions = this._getHistory()
          .map(([item]) => item)
          .filter(item => this._itemContainsQuery(query, item))
          .slice(0, this._limit);

        resolve(suggestions);
      });
    }

    _fetch() {
      return JSON.parse(localStorage.getItem(this._storeName)) || [];
    }

    _getHistory() {
      this._history = this._history || this._fetch();
      return this._history;
    }

    _itemContainsQuery(query, item) {
      return query && !$.ieq(item, query) && $.iin(item, query);
    }

    _save(history) {
      localStorage.setItem(this._storeName, JSON.stringify(history));
    }

    _setHistory(history) {
      this._history = history;
      this._save(history);
    }

    _sort(history) {
      return history.sort((current, next) => current[1] - next[1]).reverse();
    }
  }

  class Suggester {
    constructor(options) {
      this._el = $.el('#search-suggestions');
      this._influencers = options.influencers;
      this._limit = options.limit;
      this._suggestionEls = [];
      this._bindMethods();
      this._registerEvents();
    }

    setOnClick(callback) {
      this._onClick = callback;
    }

    setOnHighlight(callback) {
      this._onHighlight = callback;
    }

    setOnUnhighlight(callback) {
      this._onUnhighlight = callback;
    }

    success(query) {
      this._clearSuggestions();
      this._influencers.forEach(i => i.addItem(query));
    }

    suggest(input) {
      input = input.trim();
      if (input === '') this._clearSuggestions();

      Promise.all(this._getInfluencerPromises(input)).then(res => {
        const suggestions = this._flattenAndUnique(res);
        this._clearSuggestions();

        if (suggestions.length) {
          this._appendSuggestions(suggestions, input);
          this._registerSuggestionEvents();
          $.bodyClassAdd('suggestions');
        }
      });
    }

    _appendSuggestions(suggestions, input) {
      suggestions.some((suggestion, i) => {
        const match = new RegExp($.escapeRegex(input), 'ig');
        const suggestionHtml = suggestion.replace(match, `<b>${input}</b>`);

        this._el.insertAdjacentHTML(
          'beforeend',
          `<li>
            <button
              type="button"
              class="js-search-suggestion search-suggestion"
              data-suggestion="${suggestion}"
              tabindex="-1"
            >
              ${suggestionHtml}
            </button>
          </li>`
        );

        return i + 1 >= this._limit;
      });

      this._suggestionEls = $.els('.js-search-suggestion');
    }

    _bindMethods() {
      this._handleKeydown = this._handleKeydown.bind(this);
    }

    _clearClickEvents() {
      this._suggestionEls.forEach(el => {
        const callback = this._onClick.bind(null, el.value);
        el.removeEventListener('click', callback);
      });
    }

    _clearSuggestions() {
      $.bodyClassRemove('suggestions');
      this._clearClickEvents();
      this._suggestionEls = [];
      this._el.innerHTML = '';
    }

    // [[1, 2], [1, 2, 3, 4]] -> [1, 2, 3, 4]
    _flattenAndUnique(array) {
      return [...new Set([].concat.apply([], array))];
    }

    _focusNext(e) {
      const exists = this._suggestionEls.some((el, i) => {
        if (el.classList.contains('highlight')) {
          this._highlight(this._suggestionEls[i + 1], e);
          return true;
        }
      });

      if (!exists) this._highlight(this._suggestionEls[0], e);
    }

    _focusPrevious(e) {
      const exists = this._suggestionEls.some((el, i) => {
        if (el.classList.contains('highlight') && i) {
          this._highlight(this._suggestionEls[i - 1], e);
          return true;
        }
      });

      if (!exists) this._unHighlight(e);
    }

    _getInfluencerPromises(input) {
      return this._influencers
        .map(influencer => influencer.getSuggestions(input));
    }

    _handleKeydown(e) {
      if ($.isDown(e)) this._focusNext(e);
      if ($.isUp(e)) this._focusPrevious(e);
    }

    _highlight(el, e) {
      this._unHighlight();

      if (el) {
        this._onHighlight(el.getAttribute('data-suggestion'));
        el.classList.add('highlight');
        e.preventDefault();
      }
    }

    _registerEvents() {
      document.addEventListener('keydown', this._handleKeydown);
    }

    _registerSuggestionEvents() {
      this._suggestionEls.forEach(el => {
        const value = el.getAttribute('data-suggestion');
        el.addEventListener('mouseover', this._highlight.bind(this, el));
        el.addEventListener('mouseout', this._unHighlight.bind(this));
        el.addEventListener('click', this._onClick.bind(null, value));
      });
    }

    _unHighlight(e) {
      const el = $.el('.highlight');

      if (el) {
        this._onUnhighlight();
        el.classList.remove('highlight');
        if (e) e.preventDefault();
      }
    }
  }

  class QueryParser {
    constructor(options) {
      this._commands = options.commands;
      this._searchDelimiter = options.searchDelimiter;
      this._pathDelimiter = options.pathDelimiter;
      this._protocolRegex = /^[a-zA-Z]+:\/\//i;
      this._urlRegex = /^((https?:\/\/)?[\w-]+(\.[\w-]+)+\.?(:\d+)?(\/\S*)?)$/i;
    }

    parse(query) {
      const res = { query: query, split: null };

      if (query.match(this._urlRegex)) {
        const hasProtocol = query.match(this._protocolRegex);
        res.redirect = hasProtocol ? query : 'http://' + query;
      } else {
        const splitSearch = query.split(this._searchDelimiter);
        const splitPath = query.split(this._pathDelimiter);

        this._commands.some(([category, name, key, url, searchPath, ,materialicon]) => {
          res.isKey = query === key;
          res.isSearch = !res.isKey && splitSearch[0] === key;
          res.isPath = !res.isKey && splitPath[0] === key;

          if (res.isKey || res.isSearch || res.isPath) {
            res.key = key;

            if (res.isSearch && searchPath) {
              res.split = this._searchDelimiter;
              res.query = this._shiftAndTrim(splitSearch, res.split);
              res.redirect = this._prepSearch(url, searchPath, res.query);
            } else if (res.isPath) {
              res.split = this._pathDelimiter;
              res.path = this._shiftAndTrim(splitPath, res.split);
              res.redirect = this._prepPath(url, res.path);
            } else {
              res.redirect = url;
            }

            return true;
          }

          if (key === '*') {
            res.redirect = this._prepSearch(url, searchPath, query);
          }
        });
      }

      res.color = this._getColorFromUrl(res.redirect);
      res.logo = this._getLogoFromUrl(res.redirect);
      return res;
    }

    _getColorFromUrl(url) {
      const domain = this._getHostname(url);
      const color = this._commands
        .filter(c => this._getHostname(c[3]) === domain)
        .map(c => c[5])[0];

      return color || null;
    }

    _getLogoFromUrl(url) {
      const domain = this._getHostname(url);
      const logo = this._commands
        .filter(c => this._getHostname(c[3]) === domain)
        .map(c => c[6])[0];

      return logo || null;
    }

    _getHostname(url) {
      const parser = document.createElement('a');
      parser.href = url;
      return parser.hostname.replace(/^www./, '');
    }

    _prepPath(url, path) {
      return this._stripUrlPath(url) + '/' + path;
    }

    _prepSearch(url, searchPath, query) {
      if (!searchPath) return url;
      const baseUrl = this._stripUrlPath(url);
      const urlQuery = encodeURIComponent(query);
      searchPath = searchPath.replace('{}', urlQuery);
      return baseUrl + searchPath;
    }

    _shiftAndTrim(arr, delimiter) {
      arr.shift();
      return arr.join(delimiter).trim();
    }

    _stripUrlPath(url) {
      const parser = document.createElement('a');
      parser.href = url;
      return `${parser.protocol}//${parser.hostname}`;
    }
  }

  class Form {
    constructor(options) {
      this._formEl = $.el('#search-form');
      this._inputEl = $.el('#search-input');
      this._logoEl = $.el('#search-logo');
      this._colors = options.colors;
      this._help = options.help;
      this._suggester = options.suggester;
      this._queryParser = options.queryParser;
      this._instantRedirect = options.instantRedirect;
      this._newTab = options.newTab;
      this._inputElVal = '';
      this._bindMethods();
      this._registerEvents();
      this._loadQueryParam();
    }

    hide() {
      $.bodyClassRemove('form')
      this._inputEl.value = '';
      this._inputElVal = '';
    }

    show() {
      $.bodyClassAdd('form');
      this._inputEl.focus();
    }

    _bindMethods() {
      this.hide = this.hide.bind(this);
      this.show = this.show.bind(this);
      this._clearPreview = this._clearPreview.bind(this);
      this._handleKeydown = this._handleKeydown.bind(this);
      this._handleInput = this._handleInput.bind(this);
      this._previewValue = this._previewValue.bind(this);
      this._submitForm = this._submitForm.bind(this);
      this._submitWithValue = this._submitWithValue.bind(this);
    }

    _clearPreview() {
      this._previewValue(this._inputElVal);
      this._inputEl.focus();
    }

    _handleKeydown(e) {
      if ($.isUp(e) || $.isDown(e) || $.isRemove(e)) return;

      switch ($.key(e)) {
        case 'alt':
        case 'ctrl':
        case 'enter':
        case 'shift':
        case 'super': return;
        case 'escape': this.hide(); return;
      }

      this.show();
    }

    _handleInput() {
      const newQuery = this._inputEl.value;
      const isHelp = newQuery === '?';
      const { isKey } = this._queryParser.parse(newQuery);
      this._inputElVal = newQuery;
      this._setBackgroundFromQuery(newQuery);
      if (!newQuery || isHelp ) this.hide();
      if (isHelp) this._help.toggle();
      if (this._instantRedirect && isKey) this._submitWithValue(newQuery);
      if (this._suggester) this._suggester.suggest(newQuery);
    }

    _loadQueryParam() {
      const q = new URLSearchParams(window.location.search).get('q');
      if (q) this._submitWithValue(q);
    }

    _previewValue(value) {
      this._inputEl.value = value;
      this._setBackgroundFromQuery(value);
    }

    _redirect(redirect) {
      if (this._newTab) window.open(redirect, '_blank');
      else window.location.href = redirect;
    }

    _registerEvents() {
      document.addEventListener('keydown', this._handleKeydown);
      this._inputEl.addEventListener('input', this._handleInput);
      this._formEl.addEventListener('submit', this._submitForm, false);

      if (this._suggester) {
        this._suggester.setOnClick(this._submitWithValue);
        this._suggester.setOnHighlight(this._previewValue);
        this._suggester.setOnUnhighlight(this._clearPreview);
      }
    }

    _setBackgroundFromQuery(query) {
      if (!this._colors) return;
      const { color, logo } = this._queryParser.parse(query);
      this._formEl.style.backgroundColor = color;
      if (logo) {
        this._logoEl.src = logo;
        // show
        this._logoEl.style.display = 'block';
      } else {
        // hide
        this._logoEl.style.display = 'none';
      }
    }    
    

    _submitForm(e) {
      if (e) e.preventDefault();
      const query = this._inputEl.value;
      if (this._suggester) this._suggester.success(query);
      this.hide();
      this._redirect(this._queryParser.parse(query).redirect);
    }

    _submitWithValue(value) {
      this._inputEl.value = value;
      this._submitForm();
    }
  }
</script>

<script>
  const getHelp = () => {
    return new Help({
      commands: CONFIG.commands,
      newTab: CONFIG.newTab,
    });
  };

  const getInfluencers = () => {
    const availableInfluencers = {
      Default: DefaultInfluencer,
      DuckDuckGo: DuckDuckGoInfluencer,
      History: HistoryInfluencer,
    };

    return CONFIG.influencers.map(i => {
      return new availableInfluencers[i.name]({
        limit: i.limit,
        queryParser: getQueryParser(),
        defaultSuggestions: CONFIG.defaultSuggestions,
      });
    });
  };

  const getSuggester = () => {
    return new Suggester({
      influencers: getInfluencers(),
      limit: CONFIG.suggestionsLimit,
    });
  };

  const getQueryParser = () => {
    return new QueryParser({
      commands: CONFIG.commands,
      pathDelimiter: CONFIG.pathDelimiter,
      searchDelimiter: CONFIG.searchDelimiter,
    });
  };

  const getForm = () => {
    return new Form({
      colors: CONFIG.colors,
      help: getHelp(),
      instantRedirect: CONFIG.instantRedirect,
      newTab: CONFIG.newTab,
      queryParser: getQueryParser(),
      suggester: CONFIG.suggestions ? getSuggester() : false,
    });
  };

  new Clock({
    delimiter: CONFIG.clockDelimiter,
    form: getForm(),
  });
</script>
